<!--
  GitHub Pages QA Browser
  ---------------------------------
  A single-page app that explores any public repo with the following structure:

  /questions/
      â”œâ”€â”€ dev/
      â”‚     â”œâ”€â”€ caching.md
      â”‚     â””â”€â”€ ...
      â”œâ”€â”€ general/
      â”‚     â””â”€â”€ ...
      â””â”€â”€ strategy/
            â””â”€â”€ ...

  It builds the sidebar from first-level folders, lists the markdown files in a
  selected folder, and renders the chosen file. A fuzzy search bar lets users
  quickly jump to prompts across all categories.

  ðŸ‘‰  Before deploying, change OWNER and REPO below to your GitHub user/org and
      repo name (branch defaults to gh-pages).
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Library</title>
    <!-- Tailwind (just-in-time CDN build) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- showdown for Markdown â†’ HTML -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  </head>
  <body class="h-screen flex flex-col bg-gray-50 text-gray-800">
    <!-- Header / Search -->
    <header class="flex items-center gap-4 p-4 bg-white shadow relative z-10">
      <h1 class="text-xl font-semibold whitespace-nowrap">ðŸ“š Prompt Library</h1>
      <input
        id="searchInput"
        type="search"
        placeholder="Search promptsâ€¦"
        class="flex-1 px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring focus:ring-indigo-300"
      />
    </header>

    <main class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-64 shrink-0 overflow-y-auto border-r border-gray-200 bg-white p-4 space-y-1"
      ></aside>

      <!-- File list & content splitter -->
      <section class="flex-1 flex overflow-hidden">
        <!-- File list -->
        <div
          id="fileList"
          class="w-80 max-w-xs overflow-y-auto border-r border-gray-200 bg-gray-100 p-4 hidden lg:block"
        ></div>

        <!-- Markdown viewer -->
        <article
          id="viewer"
          class="flex-1 overflow-y-auto p-6 prose lg:prose-lg max-w-none"
        >
          <p>Select a prompt from the sidebar to begin.</p>
        </article>
      </section>
    </main>

    <script>
      // --------------------------- Configuration ------------------- --------
      const OWNER = "mar1boroman";   // âœ… change me
      const REPO = "therightquestion";          // âœ… change me
      const BRANCH = "gh-pages";                // or "main"
      const QUESTIONS_DIR = "questions";
      const apiBase = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
      const rawBase = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}`;

      // Global cache of prompts for search
      const promptsIndex = [];
      let fuse;

      // DOM helpers
      const $ = (id) => document.getElementById(id);

      // Fetch JSON helper
      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status} â€“ ${url}`);
        return res.json();
      }

      // Initialise sidebar with first-level folders
      async function loadCategories() {
        const data = await fetchJSON(`${apiBase}/${QUESTIONS_DIR}`);
        const sidebar = $("sidebar");
        data
          .filter((item) => item.type === "dir")
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((dir) => {
            const btn = document.createElement("button");
            btn.textContent = dir.name;
            btn.className =
              "w-full text-left px-3 py-2 rounded-md hover:bg-indigo-50 focus:bg-indigo-50 focus:outline-none";
            btn.addEventListener("click", () => loadFiles(dir.name));
            sidebar.appendChild(btn);
          });
      }

      // List markdown files in a subcategory
      async function loadFiles(category) {
        const fileList = $("fileList");
        fileList.innerHTML = `<h2 class="font-semibold mb-3 capitalize">${category}</h2>`;
        const files = await fetchJSON(`${apiBase}/${QUESTIONS_DIR}/${category}`);
        files
          .filter((f) => f.name.endsWith(".md"))
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((file) => {
            const link = document.createElement("a");
            link.textContent = file.name.replace(/\.md$/, "");
            link.href = "#";
            link.className =
              "block px-2 py-1 rounded hover:bg-gray-200 text-sm truncate";
            link.addEventListener("click", (e) => {
              e.preventDefault();
              renderMarkdown(category, file.name);
            });
            fileList.appendChild(link);
          });
        // show sidebar on small screens
        fileList.classList.remove("hidden");
      }

      // Fetch & render markdown file
      async function renderMarkdown(category, filename) {
        const url = `${rawBase}/${QUESTIONS_DIR}/${category}/${filename}`;
        const res = await fetch(url);
        const md = await res.text();
        const converter = new showdown.Converter({ tables: true, ghCodeBlocks: true });
        $("viewer").innerHTML = converter.makeHtml(md);
      }

      // Build search index (titles + body) once on load
      async function buildSearchIndex() {
        const dirs = await fetchJSON(`${apiBase}/${QUESTIONS_DIR}`);
        for (const dir of dirs.filter((d) => d.type === "dir")) {
          const files = await fetchJSON(`${apiBase}/${QUESTIONS_DIR}/${dir.name}`);
          for (const file of files.filter((f) => f.name.endsWith(".md"))) {
            const raw = await fetch(
              `${rawBase}/${QUESTIONS_DIR}/${dir.name}/${file.name}`
            ).then((r) => r.text());
            const [titleLine, ...body] = raw.split(/\n/);
            promptsIndex.push({
              category: dir.name,
              filename: file.name,
              title: titleLine.replace(/^#\s*/, ""),
              body: body.join("\n"),
            });
          }
        }
        fuse = new Fuse(promptsIndex, {
          keys: ["title", "body", "category"],
          threshold: 0.3,
        });
      }

      // Search handler
      $("searchInput").addEventListener("input", (e) => {
        const query = e.target.value.trim();
        if (!query) return loadFilesSearchResults([]);
        const results = fuse.search(query).slice(0, 20).map((r) => r.item);
        loadFilesSearchResults(results, query);
      });

      function loadFilesSearchResults(results, query = "") {
        const fileList = $("fileList");
        fileList.classList.remove("hidden");
        fileList.innerHTML =
          query === ""
            ? "<p class=\"text-sm text-gray-500\">Start typing to searchâ€¦</p>"
            : `<h2 class="font-semibold mb-3">Results for "${query}"</h2>`;
        results.forEach((r) => {
          const link = document.createElement("a");
          link.textContent = `${r.title} (${r.category})`;
          link.href = "#";
          link.className =
            "block px-2 py-1 rounded hover:bg-gray-200 text-sm truncate";
          link.addEventListener("click", (e) => {
            e.preventDefault();
            renderMarkdown(r.category, r.filename);
          });
          fileList.appendChild(link);
        });
      }

      // Kick-off
      (async () => {
        await loadCategories();
        await buildSearchIndex();
      })();
    </script>
  </body>
</html>
